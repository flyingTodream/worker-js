<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script>
    //    default options
const DEFAUTL_OPTIONS = {
    commitHash: null,
    onError(msg) {
        console.error(msg)
    }, onUpdate() { },
    pollingTime: 15,
    versionUrl: '/version.txt'
}

  async function createWorkjs(opt) {
    const codeString = await fetch('https://static.flytodream.cn/work.js').then(res => res.text());
            // 因此不再会有跨域问题
            const localWorkerUrl = window.URL.createObjectURL(new Blob([codeString], {
                type: 'application/javascript'
            }));
            console.log(codeString)
        if (!this.commitHash) return
        if(window.Worker){
            
            this.myWork = new Worker(localWorkerUrl)
            console.log(this.myWork)
            this.myWork.postMessage({
                type: 'VERSION',
                hash: this.commitHash,
                pollingTime: this.pollingTime,
                versionUrl: this.versionUrl
            })
            this.myWork.onmessage = async (e) => {
                const message = e.data
                console.log('onmessage')
                if (message.type && message.type === 'UPDATE') {
                    try {
                        await this.onUpdate()
                    } catch (error) {
                        this.error(error)
                    } finally{
                        this.close()
                    }
                }
            }
        }else{
            this.error('Your browser does not support web workers.')
        }
    }

// let work = new workjs({
//     commitHash: '2232323',
//     onUpdate: () => {
//         console.log('-----')
//     }
// })
// console.log()
        createWorkjs({commitHash: '2232323', pollingTime: 1, versionUrl: 'https://pass.flytodream.cn/js/chunk-vendors.28b7964b.js'})
    </script>
</body>

</html>